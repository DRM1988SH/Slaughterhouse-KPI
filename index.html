
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج قياس مؤشرات الأداء</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- React Router (UMD) -->
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              gold: {
                DEFAULT: '#c5b358',
                light: '#e6d89b',
                dark: '#a08f3a',
              }
            },
            fontFamily: {
              sans: ['Cairo', 'sans-serif'],
            }
          }
        }
      }
    </script>
    <style>
      body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      
      @keyframes slideDown {
        from { transform: translate(-50%, -100%); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
      }
      .toast-animate {
        animation: slideDown 0.3s ease-out forwards;
      }

      /* Print Styles */
      @media print {
        @page {
          margin: 0mm;
        }
        
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color-adjust: exact !important;
        }

        body {
          margin: 0;
          padding: 0;
          background: white;
          visibility: hidden;
        }

        body * {
          visibility: hidden;
        }
        
        /* Invoice Report - Landscape */
        #invoice-report, #invoice-report * {
          visibility: visible !important;
        }
        #invoice-report {
          position: fixed;
          left: 0;
          top: 0;
          width: 297mm;
          height: 210mm;
          margin: 0;
          padding: 5mm;
          background: white;
          z-index: 9999;
          box-sizing: border-box;
          display: flex !important;
          flex-direction: column !important;
          justify-content: space-between !important;
        }

        /* KPI Report - Portrait */
        #kpi-report, #kpi-report * {
          visibility: visible !important;
        }
        #kpi-report {
          position: fixed;
          left: 0;
          top: 0;
          width: 210mm;
          height: 297mm;
          margin: 0;
          padding: 0;
          background: white;
          z-index: 9999;
          box-sizing: border-box;
          display: flex !important;
          flex-direction: column !important;
        }

        /* Monthly Report - Portrait */
        #monthly-report-print, #monthly-report-print * {
          visibility: visible !important;
        }
        #monthly-report-print {
          position: fixed;
          left: 0;
          top: 0;
          width: 210mm;
          height: 297mm;
          margin: 0;
          padding: 0;
          background: white;
          z-index: 9999;
          box-sizing: border-box;
          display: flex !important;
          flex-direction: column !important;
        }
        
        .no-print {
          display: none !important;
        }
      }

      .invoice-table { border-collapse: collapse; width: 100%; font-size: inherit; }
      .invoice-table th { background-color: #f3f4f6; border: 1px solid #000; padding: 2px; text-align: center; font-weight: bold; color: #000; }
      .invoice-table td { border: 1px solid #000; padding: 1px 3px; text-align: center; vertical-align: middle; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "react-router-dom": "https://aistudiocdn.com/react-router-dom@^7.10.1"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { HashRouter, Routes, Route, Navigate, useNavigate, useLocation } = ReactRouterDOM;
        const { useState, useEffect, Fragment, useContext, createContext } = React;

        // --- CONTEXT ---
        const ToastContext = createContext(null);
        const useToast = () => useContext(ToastContext);

        // --- TYPES ---
        const UserRole = {
            ADMIN: 'ADMIN',
            DEPT_MANAGER: 'DEPT_MANAGER',
            SECTION_HEAD: 'SECTION_HEAD',
            CONTRACTOR: 'CONTRACTOR',
            USER: 'USER'
        };

        // --- DATA CONSTANTS ---
        const INITIAL_USERS = [
            { id: '70062', name: 'مصعب علي', role: UserRole.ADMIN },
            { id: '12345', name: 'عمر سعيد ', role: UserRole.DEPT_MANAGER },
            { id: '00000', name: ' حسن سالم', role: UserRole.SECTION_HEAD },
            { id: '11111', name: ' حسين محمد', role: UserRole.CONTRACTOR, facilityId: '1' },
            { id: '99999', name: 'محمد عمر', role: UserRole.USER, facilityId: '1' },
        ];

        const INITIAL_FACILITIES = [
            { 
                id: '1', 
                name: 'مسلخ أ',
                contractNumber: 'CNT-2024-001',
                operatingCompany: 'شركة الخدمات الحديثة',
                location: 'المنطقة الصناعية - القطاع 5',
                phone: '0112345678',
                email: 'info@modern-services.com'
            },
            { 
                id: '2', 
                name: 'مسلخ ب',
                contractNumber: 'CNT-2024-002',
                operatingCompany: 'شركة الإبداع للمقاولات',
                location: 'حي المصانع - طريق الملك فهد',
                phone: '0223456789',
                email: 'contracts@ibdaa-co.com'
            },
            { 
                id: '3', 
                name: 'مسلخ ج',
                contractNumber: 'CNT-2024-003',
                operatingCompany: 'شركة النظافة المتكاملة',
                location: 'المنطقة الشرقية - مجمع الصناعات',
                phone: '0334567890',
                email: 'operations@cleaning-integrated.com'
            },
        ];

        const INITIAL_EMPLOYEES = [
            { id: 'e1', name: 'عبد العزيز وفيق', jobTitle: 'مشرف المسلخ', salary: 4500, facilityId: '1' },
            { id: 'e2', name: 'محمد شهباز', jobTitle: 'مشرف النظافة', salary: 4500, facilityId: '1' },
            { id: 'e3', name: 'صافي الدين الضو', jobTitle: 'محاسب', salary: 3500, facilityId: '1' },
            { id: 'e4', name: 'احمد كمال', jobTitle: 'قصاب', salary: 2500, facilityId: '1' },
            { id: 'e5', name: 'سعيد خان', jobTitle: 'قصاب ', salary: 2300, facilityId: '1' },
            { id: 'e6', name: 'راجو كومار', jobTitle: 'قصاب', salary: 2300, facilityId: '1' },
            { id: 'e7', name: 'عمر', jobTitle: 'قصاب', salary: 2300, facilityId: '1' },
            { id: 'e8', name: 'انور ', jobTitle: 'قصاب', salary: 2300, facilityId: '1' },
            { id: 'e9', name: 'يوسف ', jobTitle: 'قصاب', salary: 2300, facilityId: '1' },
            { id: 'e10', name: 'راجو كومار', jobTitle: 'قصاب', salary: 2300, facilityId: '1' },
            { id: 'e11', name: 'راجو كومار', jobTitle: 'قصاب', salary: 2300, facilityId: '1' },
            { id: 'e12', name: 'خالد ', jobTitle: 'قصاب', salary: 2300, facilityId: '1' },
            { id: 'e13', name: 'مصطفي', jobTitle: 'عامل نظافة', salary: 2300, facilityId: '1' },
            { id: 'e14', name: 'سيد ', jobTitle: 'عامل نظافة', salary: 2300, facilityId: '1' },
            { id: 'e15', name: 'معتز ', jobTitle: 'عامل نظافة', salary: 2300, facilityId: '1' },
            { id: 'e16', name: 'راجو سون', jobTitle: 'عامل نظافة', salary: 2300, facilityId: '1' },
            { id: 'e17', name: 'طاهر ', jobTitle: 'عامل نظافة', salary: 2300, facilityId: '1' },
            { id: 'e18', name: 'ايمن  ', jobTitle: 'حمال', salary: 2300, facilityId: '1' },
        ];

        const INITIAL_VIOLATIONS = [
            { id: 'v1', name: 'غياب الموظف', fineAmount: 250 },
            { id: 'v2', name: 'عدم توفير التقارير الإدارية اليومية', fineAmount: 100 },
            { id: 'v3', name: 'عدم توفير التقارير الشهرية', fineAmount: 100 },
            { id: 'v4', name: 'عدم توفير سجلات إدارية', fineAmount: 200 },
            { id: 'v5', name: 'عدم توفير معدات العمل', fineAmount: 500 },
            { id: 'v6', name: 'عدم صيانة معدات العمل (بعد 3 أيام)', fineAmount: 500 },
            { id: 'v7', name: 'عدم معايرة معدات العمل', fineAmount: 500 },
            { id: 'v8', name: 'عدم توفير شهادات تدريب السلامة المهنية', fineAmount: 100 },
            { id: 'v9', name: 'عدم توفير شهادات اللياقة الصحية', fineAmount: 100 },
            { id: 'v10', name: 'عدم توفير بطاقة دخول مسلخ', fineAmount: 100 },
            { id: 'v11', name: 'عدم توفير شهادة تدريب السلامة الغذائية', fineAmount: 100 },
            { id: 'v12', name: 'عدم نظافة المعدات والأدوات', fineAmount: 500 },
            { id: 'v13', name: 'سوء نظافة اللحوم', fineAmount: 500 },
            { id: 'v14', name: 'سوء النظافة الشخصية', fineAmount: 200 },
            { id: 'v15', name: 'عدم الالتزام بالزي الرسمي', fineAmount: 100 },
            { id: 'v16', name: 'عدم التزام الموظف بإجراءات السلامة المهنية', fineAmount: 100 },
            { id: 'v17', name: 'عدم تطبيق شروط الذبح الشرعية', fineAmount: 100 },
            { id: 'v18', name: 'أي فحص مختبري يثبت حالة إيجابية', fineAmount: 5000 },
            { id: 'v19', name: 'الذبح في غياب الطبيب البيطري', fineAmount: 3000 },
        ];

        const INITIAL_ITEMS = [
            { id: 'i1', name: 'الحضور والانصراف', category: 'ADMIN', linkedViolationId: 'v1' },
            { id: 'i2', name: 'التقارير الإدارية اليومية', category: 'ADMIN', linkedViolationId: 'v2' },
            { id: 'i3', name: 'التقارير الشهرية', category: 'ADMIN', linkedViolationId: 'v3' },
            { id: 'i4', name: 'سجلات إدارية', category: 'ADMIN', linkedViolationId: 'v4' },
            { id: 'i5', name: 'توفير معدات العمل', category: 'OPERATIONAL', linkedViolationId: 'v5' },
            { id: 'i6', name: 'صيانة معدات العمل', category: 'OPERATIONAL', linkedViolationId: 'v6' },
            { id: 'i7', name: 'معايرة معدات العمل', category: 'OPERATIONAL', linkedViolationId: 'v7' },
            { id: 'i8', name: 'شهادات تدريب السلامة المهنية', category: 'PROFESSIONAL', linkedViolationId: 'v8' },
            { id: 'i9', name: 'شهادات اللياقة الصحية', category: 'PROFESSIONAL', linkedViolationId: 'v9' },
            { id: 'i10', name: 'بطاقة دخول مسلخ', category: 'PROFESSIONAL', linkedViolationId: 'v10' },
            { id: 'i11', name: 'شهادة تدريب السلامة الغذائية', category: 'PROFESSIONAL', linkedViolationId: 'v11' },
            { id: 'i12', name: 'نظافة المعدات والأدوات', category: 'HYGIENE', linkedViolationId: 'v12' },
            { id: 'i13', name: 'نظافة اللحوم', category: 'HYGIENE', linkedViolationId: 'v13' },
            { id: 'i14', name: 'النظافة الشخصية', category: 'HYGIENE', linkedViolationId: 'v14' },
            { id: 'i15', name: 'الالتزام بالزي الرسمي', category: 'SAFETY', linkedViolationId: 'v15' },
            { id: 'i16', name: 'التزام بإجراءات السلامة المهنية', category: 'SAFETY', linkedViolationId: 'v16' },
            { id: 'i17', name: 'تطبيق شروط الذبح الشرعية', category: 'SAFETY', linkedViolationId: 'v17' },
            { id: 'i18', name: 'فحص المختبري', category: 'LAB', linkedViolationId: 'v18' },
            { id: 'i19', name: 'تقرير الذبيح اليومي', category: 'ADMIN', linkedViolationId: 'v2' },
        ];

        const INVOICE_EMPLOYEE_STRUCTURE = [
            { role: 'مشرف المسلخ', count: 1, monthlySalary: 4500, dailySalary: 150, expectedDays: 30, actualDays: 30, absentDays: 0 },
            { role: 'مشرف النظافة', count: 1, monthlySalary: 4500, dailySalary: 150, expectedDays: 30, actualDays: 30, absentDays: 0 },
            { role: 'محاسب', count: 1, monthlySalary: 3500, dailySalary: 117, expectedDays: 30, actualDays: 30, absentDays: 0 },
            { role: 'قصاب', count: 9, monthlySalary: 2500, dailySalary: 83, expectedDays: 30, actualDays: 30, absentDays: 0 },
            { role: 'عامل نظافة', count: 5, monthlySalary: 2300, dailySalary: 77, expectedDays: 30, actualDays: 30, absentDays: 0 },
            { role: 'حمال', count: 1, monthlySalary: 2300, dailySalary: 77, expectedDays: 30, actualDays: 30, absentDays: 0 },
        ];

        const EXTRA_LABOR_STRUCTURE = [
            { role: 'جزار إضافي', count: 0, monthlySalary: 2500, dailySalary: 83 },
            { role: 'عامل نظافة إضافي', count: 0, monthlySalary: 2300, dailySalary: 77 },
            { role: 'حمال إضافي', count: 0, monthlySalary: 2300, dailySalary: 77 },
        ];

        const CLEANING_MATERIAL_COST = 40000;

        // --- STORAGE SERVICE ---
        const getStorage = (key, defaultVal) => {
            const stored = localStorage.getItem(key);
            if (!stored) return defaultVal;
            try { return JSON.parse(stored); } catch { return defaultVal; }
        };
        const setStorage = (key, val) => localStorage.setItem(key, JSON.stringify(val));

        // Simple Event Bus
        const listeners = [];
        const subscribe = (listener) => {
            listeners.push(listener);
            return () => {
                const index = listeners.indexOf(listener);
                if (index > -1) listeners.splice(index, 1);
            };
        };
        const notifyChange = () => listeners.forEach(l => l());

        const DataService = {
            subscribe,
            users: { getAll: () => getStorage('users', INITIAL_USERS), save: (v) => { setStorage('users', v); notifyChange(); } },
            facilities: { getAll: () => getStorage('facilities', INITIAL_FACILITIES), save: (v) => { setStorage('facilities', v); notifyChange(); } },
            employees: { getAll: () => getStorage('employees', INITIAL_EMPLOYEES), save: (v) => { setStorage('employees', v); notifyChange(); } },
            items: { getAll: () => getStorage('items', INITIAL_ITEMS), save: (v) => { setStorage('items', v); notifyChange(); } },
            violationTypes: { getAll: () => getStorage('violationTypes', INITIAL_VIOLATIONS), save: (v) => { setStorage('violationTypes', v); notifyChange(); } },
            evaluations: { 
                getAll: () => getStorage('evaluations', []), 
                save: (v) => { setStorage('evaluations', v); notifyChange(); },
                add: (entry) => {
                    const list = getStorage('evaluations', []);
                    const existingIdx = list.findIndex(e => e.date === entry.date && e.facilityId === entry.facilityId);
                    if (existingIdx >= 0) list[existingIdx] = entry;
                    else list.push(entry);
                    setStorage('evaluations', list);
                    notifyChange();
                }
            },
            violations: { getAll: () => getStorage('violations', []), save: (v) => { setStorage('violations', v); notifyChange(); } },
            extraLabor: { getAll: () => getStorage('extraLabor', []), save: (v) => { setStorage('extraLabor', v); notifyChange(); } },
            invoices: { getAll: () => getStorage('invoices', []), save: (v) => { setStorage('invoices', v); notifyChange(); } },
            monthlyReports: { getAll: () => getStorage('monthlyReports', []), save: (v) => { setStorage('monthlyReports', v); notifyChange(); } },
            kpiReports: { getAll: () => getStorage('kpiReports', []), save: (v) => { setStorage('kpiReports', v); notifyChange(); } },
            settings: { get: () => getStorage('appSettings', {}), save: (v) => { setStorage('appSettings', v); notifyChange(); } }
        };

        // --- UTILS ---
        const ones = ["", "واحد", "اثنان", "ثلاثة", "أربعة", "خمسة", "ستة", "سبعة", "ثمانية", "تسعة"];
        const tens = ["", "عشرة", "عشرون", "ثلاثون", "أربعون", "خمسون", "ستون", "سبعون", "ثمانون", "تسعون"];
        const teens = ["عشر", "أحد عشر", "اثنا عشر", "ثلاثة عشر", "أربعة عشر", "خمسة عشر", "ستة عشر", "سبعة عشر", "ثمانية عشر", "تسعة عشر"];
        const hundreds = ["", "مائة", "مائتان", "ثلاثمائة", "أربعمائة", "خمسمائة", "ستمائة", "سبعمائة", "ثمانمائة", "تسعمائة"];

        function convertGroup(n) {
            if (n === 0) return "";
            if (n < 10) return ones[n];
            if (n < 20) return teens[n - 10];
            if (n < 100) {
                const unit = n % 10;
                const ten = Math.floor(n / 10);
                return unit > 0 ? `${ones[unit]} و${tens[ten]}` : tens[ten];
            }
            if (n < 1000) {
                const hundred = Math.floor(n / 100);
                const remainder = n % 100;
                return remainder > 0 ? `${hundreds[hundred]} و${convertGroup(remainder)}` : hundreds[hundred];
            }
            return "";
        }

        function numberToArabicText(n) {
            if (n === 0) return "صفر";
            const parts = n.toString().split('.');
            const integerPart = parseInt(parts[0], 10);
            const decimalPart = parts.length > 1 ? parseInt(parts[1].substring(0, 2).padEnd(2, '0'), 10) : 0;
            let text = "";
            const m = Math.floor(integerPart / 1000000);
            const remM = integerPart % 1000000;
            const t = Math.floor(remM / 1000);
            const u = remM % 1000;

            if (m > 0) text += (m >= 3 && m <= 10) ? `${ones[m].replace('ة', '')} ملايين` : `${convertGroup(m)} مليون`;
            if (t > 0) { if (text !== "") text += " و"; text += (t >= 3 && t <= 10) ? `${ones[t].replace('ة', '')} آلاف` : `${convertGroup(t)} ألف`; }
            if (u > 0) { if (text !== "") text += " و"; text += convertGroup(u); }
            text += " درهم";
            if (decimalPart > 0) { text += " و"; text += convertGroup(decimalPart); text += " فلساً"; }
            return `فقط ${text} لاغير`;
        }

        const formatMonthYearArabic = (monthStr) => {
            if (!monthStr) return '';
            const date = new Date(monthStr + '-01');
            return date.toLocaleDateString('ar-AE', { month: 'long', year: 'numeric' });
        };

        const getCurrentDateTime = () => new Date().toLocaleString('ar-AE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });

        const isApplicable = (item, emp) => {
            const title = emp.jobTitle;
            if (['i1', 'i15', 'i16', 'i8', 'i9', 'i10'].includes(item.id)) return true;
            if (['i2', 'i3', 'i4', 'i5', 'i6', 'i7', 'i18'].includes(item.id)) return title === 'مشرف المسلخ';
            if (['i12', 'i14'].includes(item.id)) return title === 'عامل نظافة' || title === 'مشرف النظافة' || title === 'حمال';
            if (['i17', 'i11', 'i13'].includes(item.id)) return title === 'قصاب';
            if (item.id === 'i19') return title === 'محاسب';
            return false;
        };

        const textToImage = (text, options) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            if (!ctx) return '';
            const scale = 4;
            const width = (options.width || 400);
            const height = 100;
            canvas.width = width * scale;
            canvas.height = height * scale;
            ctx.scale(scale, scale);
            const weight = options.fontWeight || 'bold';
            ctx.font = `${weight} ${options.fontSize}px Cairo, sans-serif`;
            ctx.fillStyle = options.color || "#000000";
            ctx.textBaseline = 'middle';
            if (options.align === 'right') { ctx.textAlign = 'right'; ctx.fillText(text, width - 2, height / 2); }
            else if (options.align === 'left') { ctx.textAlign = 'left'; ctx.fillText(text, 2, height / 2); }
            else { ctx.textAlign = 'center'; ctx.fillText(text, width / 2, height / 2); }
            return canvas.toDataURL('image/png');
        };

        const exportToPDF = (elementId, fileName, orientation, headerInfo, options = { repeatHeader: true }) => {
            const element = document.getElementById(elementId);
            if (!element) return;
            const settings = DataService.settings.get();
            const logo = settings.logo;
            const themeColor = '#F0DB7D';
            const pxToIn = (px) => px / 96;
            const hHeight = pxToIn(100);
            const fHeight = pxToIn(20);
            const logoSize = pxToIn(80);
            const topMargin = 1.5;
            const opt = {
                margin: [topMargin, 0, fHeight, 0],
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'in', format: 'a4', orientation: orientation }
            };

            if (window.html2pdf) {
                window.html2pdf().from(element).set(opt).toPdf().get('pdf').then((pdf) => {
                    const totalPages = pdf.internal.getNumberOfPages();
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    
                    let titleImg = headerInfo ? textToImage(headerInfo.title, { fontSize: 28, color: '#000000', align: 'center', width: 600 }) : '';
                    let dateImg = headerInfo ? textToImage(headerInfo.date, { fontSize: 22, color: '#000000', align: 'right', width: 300 }) : '';
                    let facilityImg = headerInfo ? textToImage(headerInfo.facility, { fontSize: 22, color: '#000000', align: 'left', width: 300 }) : '';
                    
                    const authTextImg = textToImage("نسخة الكترونية معتمدة", { fontSize: 30, color: '#000000', align: 'center', width: 500, fontWeight: 'bold' });

                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        if (i === 1 || options.repeatHeader) {
                            pdf.setFillColor(themeColor);
                            pdf.rect(0, 0, pageWidth, hHeight, 'F');
                            if (logo) {
                                const yPos = (hHeight - logoSize) / 2;
                                const xPos = pageWidth - 0.2 - logoSize;
                                pdf.addImage(logo, 'PNG', xPos, yPos, logoSize, logoSize);
                            }
                        }
                        if (i === 1) {
                            if (titleImg) pdf.addImage(titleImg, 'PNG', (pageWidth - 3.0) / 2, hHeight + 0.05, 3.0, 0.5);
                            if (dateImg) pdf.addImage(dateImg, 'PNG', pageWidth - 2.0 - 0.2, hHeight + 0.9, 2.0, 0.25);
                            if (facilityImg) pdf.addImage(facilityImg, 'PNG', 0.2, hHeight + 0.9, 2.0, 0.25);
                        }
                        pdf.setFillColor(themeColor);
                        pdf.rect(0, pageHeight - fHeight, pageWidth, fHeight, 'F');
                        const yText = pageHeight - (fHeight / 2) + 0.04;
                        pdf.setFontSize(8); pdf.setTextColor(0, 0, 0);
                        pdf.text("SH-KPI", 0.1, yText);
                        pdf.text(`Page ${i} of ${totalPages}`, pageWidth - 0.1, yText, { align: 'right' });
                        if (authTextImg) {
                            const imgH = fHeight - 0.05; 
                            const imgW = imgH * 5.5; 
                            pdf.addImage(authTextImg, 'PNG', (pageWidth - imgW) / 2, pageHeight - fHeight + 0.02, imgW, imgH);
                        }
                    }
                }).save();
            } else { 
                alert('مكتبة PDF غير محملة.'); 
                window.print(); 
            }
        };

        // --- COMPONENTS ---
        
        // TOAST
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            const iconClass = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';

            return (
                <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 ${bgClass} text-white px-6 py-3 rounded-lg shadow-xl z-[9999] flex items-center gap-2 toast-animate`}>
                    <i className={`fa ${iconClass} text-xl`}></i>
                    <span className="font-bold">{message}</span>
                </div>
            );
        };

        const ToastProvider = ({ children }) => {
            const [toast, setToast] = useState(null);
            const showToast = (msg, type = 'success') => setToast({ message: msg, type });
            return (
                <ToastContext.Provider value={{ showToast }}>
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    {children}
                </ToastContext.Provider>
            );
        };

        // LOGIN
        const Login = ({ onLogin }) => {
            const [id, setId] = useState('');
            const [error, setError] = useState('');
            const settings = DataService.settings.get();
            const handleLogin = (e) => {
                e.preventDefault();
                const users = DataService.users.getAll();
                const user = users.find(u => u.id === id);
                if (user) onLogin(user); else setError('الرمز الوظيفي غير صحيح');
            };
            return (
                <div className="min-h-screen w-full flex items-center justify-center bg-gray-800 relative" dir="rtl">
                    {settings.loginBackground && <div className="absolute inset-0 bg-cover bg-center z-0" style={{ backgroundImage: `url(${settings.loginBackground})`, opacity: 0.5 }}></div>}
                    <div className="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md z-10 text-center relative">
                        <h2 className="text-2xl font-bold mb-6 text-gold-dark">تسجيل الدخول</h2>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-2 text-right">الرمز الوظيفي</label>
                                <input type="text" value={id} onChange={(e) => setId(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-gold text-center text-xl tracking-widest" placeholder="أدخل الرمز الوظيفي" autoFocus />
                            </div>
                            {error && <p className="text-red-500 text-sm">{error}</p>}
                            <button type="submit" className="w-full bg-gold hover:bg-gold-dark text-white font-bold py-3 px-4 rounded transition duration-200">دخول</button>
                        </form>
                    </div>
                </div>
            );
        };

        // LAYOUT
        const Layout = ({ children, currentUser, onLogout }) => {
            const navigate = useNavigate();
            const location = useLocation();
            const [dateTime, setDateTime] = useState(getCurrentDateTime());
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [violationCount, setViolationCount] = useState(0);
            const settings = DataService.settings.get();

            useEffect(() => { const t = setInterval(() => setDateTime(getCurrentDateTime()), 1000); return () => clearInterval(t); }, []);
            
            useEffect(() => {
                const updateCount = () => {
                    const count = DataService.violations.getAll().filter(v => (currentUser.role === UserRole.ADMIN || v.facilityId === currentUser.facilityId) && v.status === 'OPEN').length;
                    setViolationCount(count);
                };
                updateCount();
                const unsubscribe = DataService.subscribe(updateCount);
                return () => unsubscribe();
            }, [location.pathname, currentUser]);

            const menuItems = [
                { label: 'التقييم اليومي', path: '/daily-evaluation', icon: 'fa-calendar-check' },
                { label: 'المخالفات', path: '/violations', icon: 'fa-exclamation-triangle', badge: violationCount },
                { label: 'التقييم الشهري', path: '/monthly-evaluation', icon: 'fa-table' },
                { label: 'التقرير الشهري', path: '/monthly-report', icon: 'fa-file-text' },
                { label: 'مؤشر الأداء', path: '/kpi', icon: 'fa-chart-pie' },
                { label: 'الفاتورة الشهرية', path: '/invoice', icon: 'fa-file-invoice-dollar' },
                { label: 'العمالة الإضافية', path: '/extra-labor', icon: 'fa-users-cog' },
                { label: 'الاعدادات', path: '/settings', icon: 'fa-cogs', roles: [UserRole.ADMIN] },
            ];

            return (
                <div className="flex h-screen bg-gray-100 overflow-hidden" dir="rtl">
                    <div className={`${isSidebarOpen ? 'w-64' : 'w-0'} bg-white shadow-lg transition-all duration-300 flex flex-col no-print`}>
                        <div className="h-[150px] flex items-center justify-center border-b p-4">
                            {settings.logo ? <img src={settings.logo} className="max-h-full max-w-full object-contain" /> : <div className="text-gray-400 text-center"><i className="fa fa-image fa-3x"></i><br/>شعار المؤسسة</div>}
                        </div>
                        <div className="flex-1 overflow-y-auto py-4">
                            {menuItems.filter(item => !item.roles || item.roles.includes(currentUser.role)).map((item) => (
                                <button key={item.path} onClick={() => navigate(item.path)} className={`w-full flex items-center px-6 py-3 text-right hover:bg-gold-light hover:text-white transition-colors ${location.pathname === item.path ? 'bg-gold text-white' : 'text-gray-700'}`}>
                                    <i className={`fa ${item.icon} w-8 text-center ml-2`}></i><span className="flex-1 font-semibold">{item.label}</span>
                                    {item.badge ? <span className="bg-red-500 text-white text-xs rounded-full px-2 py-0.5 animate-pulse">{item.badge}</span> : null}
                                </button>
                            ))}
                        </div>
                        <div className="p-4 border-t"><button onClick={onLogout} className="w-full bg-red-50 text-red-600 py-2 rounded hover:bg-red-100"><i className="fa fa-sign-out-alt ml-2"></i> تسجيل خروج</button></div>
                    </div>
                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="h-[60px] bg-gold text-white flex items-center justify-between px-6 shadow-md no-print">
                            <div className="flex items-center"><button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="text-white hover:text-gray-200"><i className="fa fa-bars fa-lg"></i></button><h1 className="mr-4 text-xl font-bold">برنامج قياس مؤشرات الأداء</h1></div>
                            <div className="flex items-center gap-4 text-sm font-semibold dir-ltr"><span>{dateTime}</span><button onClick={() => navigate(-1)} className="bg-white/20 hover:bg-white/30 p-1 rounded-full w-8 h-8 flex items-center justify-center"><i className="fa fa-arrow-left"></i></button></div>
                        </header>
                        <main className="flex-1 overflow-auto p-4 sm:p-6 print:p-0 print:overflow-visible">{children}</main>
                        <footer className="h-[20px] bg-gold text-white text-xs flex items-center justify-between px-4 no-print"><span>جميع الحقوق محفوظة</span><span>SH-KPI v1.0</span></footer>
                    </div>
                </div>
            );
        };

        // PAGES
        
        // Daily Eval
        const DailyEvaluationPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [items, setItems] = useState([]);
            const [employees, setEmployees] = useState([]);
            const [violationTypes, setViolationTypes] = useState([]);
            const [scores, setScores] = useState({});
            const [submitted, setSubmitted] = useState(false);
            const [isUpdateMode, setIsUpdateMode] = useState(false);
            const [facilityName, setFacilityName] = useState('');
            const [todaysViolations, setTodaysViolations] = useState([]);
            const [facilities, setFacilities] = useState([]);
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const [performanceIndex, setPerformanceIndex] = useState(100);
            const [unresolvedFailures, setUnresolvedFailures] = useState([]);
            const isAdmin = currentUser.role === UserRole.ADMIN;

            useEffect(() => {
                setItems(DataService.items.getAll());
                setViolationTypes(DataService.violationTypes.getAll());
                setFacilities(DataService.facilities.getAll());
                if (!isAdmin && currentUser.facilityId) setSelectedFacility(currentUser.facilityId);
            }, [currentUser, isAdmin]);

            useEffect(() => {
                const f = facilities.find(fac => fac.id === selectedFacility);
                setFacilityName(f ? f.name : 'المسلخ الرئيسي');
                const allEmps = DataService.employees.getAll();
                setEmployees(allEmps.filter(e => e.facilityId === selectedFacility));
            }, [selectedFacility, facilities]);

            useEffect(() => {
                const load = () => {
                    const all = DataService.violations.getAll();
                    setTodaysViolations(all.filter(v => v.date === date && v.facilityId === selectedFacility));
                    const allEvals = DataService.evaluations.getAll();
                    const existing = allEvals.find(e => e.date === date && e.facilityId === selectedFacility);
                    if (existing) {
                        setScores(existing.scores);
                        setSubmitted(existing.submitted);
                        setIsUpdateMode(true);
                        calculatePerformanceIndex(existing.scores);
                        calculateUnresolvedFailures(existing.scores, all.filter(v => v.date === date && v.facilityId === selectedFacility));
                    } else {
                        const initScores = {};
                        DataService.items.getAll().forEach(item => {
                            employees.forEach(emp => { if (isApplicable(item, emp)) initScores[`${item.id}_${emp.id}`] = true; });
                        });
                        setScores(initScores);
                        setSubmitted(false);
                        setIsUpdateMode(false);
                        calculatePerformanceIndex(initScores);
                        setUnresolvedFailures([]);
                    }
                };
                if(employees.length > 0) load();
            }, [date, selectedFacility, employees]);

            const calculatePerformanceIndex = (currentScores) => {
                const total = Object.keys(currentScores).length;
                if (total === 0) {
                    setPerformanceIndex(100);
                    return;
                }
                const passed = Object.values(currentScores).filter(v => v).length;
                const calculatedIndex = Math.round((passed / total) * 100);
                setPerformanceIndex(calculatedIndex);
            };

            const calculateUnresolvedFailures = (currentScores, violations) => {
                const failedItems = [];
                Object.entries(currentScores).forEach(([key, passed]) => {
                    if (!passed) {
                        const [itemId, empId] = key.split('_');
                        const item = items.find(i => i.id === itemId);
                        const emp = employees.find(e => e.id === empId);
                        if (item && emp && item.linkedViolationId) {
                            const violationCount = violations.filter(v => v.violationTypeId === item.linkedViolationId).length;
                            let failureCount = 0;
                            Object.entries(currentScores).forEach(([k, p]) => {
                                if (!p) {
                                    const [iId, eId] = k.split('_');
                                    const i = items.find(it => it.id === iId);
                                    if (i && i.linkedViolationId === item.linkedViolationId) {
                                        failureCount++;
                                    }
                                }
                            });
                            
                            if (failureCount > violationCount) {
                                failedItems.push({ key, item, emp });
                            }
                        } else if (item && emp && !item.linkedViolationId) {
                            failedItems.push({ key, item, emp });
                        }
                    }
                });
                setUnresolvedFailures(failedItems);
            };

            const handleCheck = (itemId, empId) => { 
                if (!submitted) {
                    const newScores = { ...scores, [`${itemId}_${empId}`]: !scores[`${itemId}_${empId}`] };
                    setScores(newScores);
                    calculatePerformanceIndex(newScores);
                    calculateUnresolvedFailures(newScores, todaysViolations);
                }
            };

            const handleRegisterViolation = (key, item, emp) => {
                if (!item.linkedViolationId) return alert('لا يوجد نوع مخالفة مرتبط');
                const vType = violationTypes.find(v => v.id === item.linkedViolationId);
                const newV = { 
                    id: `${Date.now()}-${Math.floor(Math.random() * 1000)}`, 
                    date, 
                    violationTypeId: vType.id, 
                    violationName: `${vType.name} - ${emp.name}`, 
                    amount: vType.fineAmount, 
                    count: 1, 
                    total: vType.fineAmount, 
                    enteredBy: currentUser.name, 
                    status: 'OPEN', 
                    facilityId: selectedFacility 
                };
                DataService.violations.save([...DataService.violations.getAll(), newV]);
                setTodaysViolations(prev => [...prev, newV]);
                calculateUnresolvedFailures(scores, [...todaysViolations, newV]);
                showToast(`تم تسجيل مخالفة: ${vType.name}`, 'error');
            };

            const handleEdit = () => {
                setSubmitted(false);
            };

            const handleSubmit = () => {
                if (submitted) return;
                
                if (unresolvedFailures.length > 0) {
                    return alert('يوجد بنود فاشلة بدون تسجيل مخالفات. الرجاء تسجيل المخالفات قبل الاعتماد.');
                }
                
                const ev = { 
                    id: Date.now().toString(), 
                    date, 
                    facilityId: selectedFacility, 
                    enteredBy: currentUser.name, 
                    scores, 
                    submitted: true,
                    performanceIndex: performanceIndex
                };
                
                DataService.evaluations.add(ev);
                setSubmitted(true);
                setIsUpdateMode(true);
                showToast(`تم الاعتماد. مؤشر الأداء النهائي: ${performanceIndex}%`);
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex flex-wrap justify-between items-center gap-4">
                        <div className="flex items-center gap-4">
                            <h2 className="text-xl font-bold">التقييم اليومي: {facilityName}</h2>
                            {isAdmin && (
                                <select value={selectedFacility} onChange={e => setSelectedFacility(e.target.value)} className="border p-2 rounded">
                                    {facilities.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}
                                </select>
                            )}
                        </div>
                        <div>
                            <label>التاريخ: </label>
                            <input type="date" value={date} onChange={e => setDate(e.target.value)} className="border p-1 rounded" />
                        </div>
                    </div>
                    <div className="bg-white p-4 rounded shadow overflow-x-auto">
                        <table className="w-full text-sm text-right border-collapse min-w-[1000px]">
                            <thead>
                                <tr>
                                    <th className="border p-2 bg-gray-50 w-1/5 sticky right-0 bg-gray-100 z-10">البنود / الموظفين</th>
                                    {employees.map(emp => (
                                        <th key={emp.id} className="border p-2 bg-gray-50 text-center">
                                            <div className="font-bold">{emp.name}</div>
                                            <div className="text-xs text-gray-500">{emp.jobTitle}</div>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {items.map(item => (
                                    <tr key={item.id} className="hover:bg-gray-50">
                                        <td className="border p-2 font-medium sticky right-0 bg-white z-10 shadow-sm">
                                            {item.name}
                                            <div className="text-xs text-gray-400">{item.category}</div>
                                        </td>
                                        {employees.map(emp => {
                                            const app = isApplicable(item, emp);
                                            return (
                                                <td key={emp.id} className={`border p-2 text-center ${app ? '' : 'bg-gray-100'}`}>
                                                    {app ? (
                                                        <input 
                                                            type="checkbox" 
                                                            checked={scores[`${item.id}_${emp.id}`] || false} 
                                                            onChange={() => handleCheck(item.id, emp.id)} 
                                                            disabled={submitted} 
                                                            className="w-5 h-5 cursor-pointer" 
                                                        />
                                                    ) : (
                                                        <span className="text-gray-300">-</span>
                                                    )}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="flex flex-col md:flex-row gap-6">
                        <div className="bg-white p-4 rounded shadow flex-1">
                            <h3 className="font-bold mb-2">مؤشر الأداء: {performanceIndex}%</h3>
                            <div className="h-2 rounded bg-gray-200 overflow-hidden">
                                <div style={{ width: `${performanceIndex}%` }} className={`h-full ${performanceIndex < 100 ? 'bg-red-500' : 'bg-green-500'}`}></div>
                            </div>
                            <p className="text-sm text-gray-500 mt-1">المؤشر لا يتغير عند تسجيل المخالفات</p>
                            
                            {unresolvedFailures.length > 0 && (
                                <div className="mt-4 border-t pt-4">
                                    <h4 className="font-bold text-red-700 mb-2">مخالفات مطلوبة:</h4>
                                    <ul className="space-y-2">
                                        {unresolvedFailures.map(({ key, item, emp }) => (
                                            <li key={key} className="flex justify-between bg-red-50 p-2 rounded">
                                                <div>{item.name} - {emp.name}</div>
                                                <button 
                                                    onClick={() => handleRegisterViolation(key, item, emp)} 
                                                    className="bg-red-600 text-white px-2 py-1 rounded text-xs"
                                                >
                                                    تسجيل مخالفة
                                                </button>
                                            </li>
                                        ))}
                                    </ul>
                                    <p className="text-xs text-gray-500 mt-2">
                                        ملاحظة: يجب تسجيل مخالفة لكل بند فاشل قبل الاعتماد
                                    </p>
                                </div>
                            )}
                        </div>
                        <div className="flex-1 flex items-end justify-end gap-4">
                            {submitted && (
                                <button onClick={handleEdit} className="px-6 py-3 bg-blue-600 text-white rounded font-bold">
                                    تعديل
                                </button>
                            )}
                            <button 
                                onClick={handleSubmit} 
                                disabled={submitted || unresolvedFailures.length > 0} 
                                className={`px-8 py-3 rounded font-bold text-white ${submitted ? 'bg-gray-400' : unresolvedFailures.length > 0 ? 'bg-gray-400' : 'bg-gold'}`}
                            >
                                {submitted ? 'تم الاعتماد' : (isUpdateMode ? 'تحديث البيانات' : 'اعتماد التقييم')}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Violations Page
        const ViolationsPage = ({ currentUser }) => {
            const [violations, setViolations] = useState([]);
            const [filterMonth, setFilterMonth] = useState(new Date().toISOString().slice(0, 7));
            const [facilities, setFacilities] = useState(DataService.facilities.getAll());
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const canSelect = [UserRole.ADMIN, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD].includes(currentUser.role);

            useEffect(() => { 
                setFacilities(DataService.facilities.getAll()); 
                if (!canSelect && currentUser.facilityId) setSelectedFacility(currentUser.facilityId); 
            }, [currentUser, canSelect]);

            useEffect(() => {
                let filtered = DataService.violations.getAll();
                filtered = filtered.filter(v => v.facilityId === selectedFacility);
                if (filterMonth) filtered = filtered.filter(v => v.date.startsWith(filterMonth));
                setViolations(filtered);
            }, [filterMonth, selectedFacility]);

            const closeV = (id) => {
                const all = DataService.violations.getAll();
                const updated = all.map(v => v.id === id ? { ...v, status: 'CLOSED' } : v);
                DataService.violations.save(updated);
                setViolations(prev => prev.map(v => v.id === id ? { ...v, status: 'CLOSED' } : v));
            };

            const handleExport = () => exportToPDF('violation-report', `Violations-${filterMonth}.pdf`, 'portrait', { title: 'سجل المخالفات', facility: facilities.find(f => f.id === selectedFacility)?.name || '', date: formatMonthYearArabic(filterMonth) });

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex flex-wrap justify-between items-center gap-4 no-print">
                        <h2 className="text-xl font-bold text-gold-dark">سجل المخالفات</h2>
                        <div className="flex gap-2">
                            {canSelect && <select value={selectedFacility} onChange={e => setSelectedFacility(e.target.value)} className="border p-2 rounded">{facilities.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}</select>}
                            <input type="month" value={filterMonth} onChange={e => setFilterMonth(e.target.value)} className="border p-2 rounded" />
                            <button onClick={handleExport} className="bg-blue-600 text-white px-3 py-2 rounded">PDF</button>
                        </div>
                    </div>
                    <div id="violation-report" className="bg-white p-4 rounded shadow mt-6">
                        <table className="w-full text-sm text-right border-collapse">
                            <thead><tr className="bg-gold text-white"><th className="p-3 border">م</th><th className="p-3 border">التاريخ</th><th className="p-3 border">المخالفة</th><th className="p-3 border">القيمة</th><th className="p-3 border">الحالة</th><th className="p-3 border no-print"></th></tr></thead>
                            <tbody>
                                {violations.map((v, i) => (
                                    <tr key={v.id} className="border-b"><td className="p-3 border">{i + 1}</td><td className="p-3 border">{v.date}</td><td className="p-3 border">{v.violationName}</td><td className="p-3 border">{v.amount}</td><td className="p-3 border">{v.status}</td><td className="p-3 border no-print">{v.status === 'OPEN' && (currentUser.role === UserRole.ADMIN || currentUser.role === UserRole.USER) && <button onClick={() => closeV(v.id)} className="bg-blue-500 text-white px-2 py-1 rounded text-xs">إغلاق</button>}</td></tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Monthly Eval
        const MonthlyEvaluationPage = ({ currentUser }) => {
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [items, setItems] = useState([]);
            const [employees, setEmployees] = useState([]);
            const [evaluations, setEvaluations] = useState([]);
            const [daysInMonth, setDaysInMonth] = useState([]);
            const [facilities, setFacilities] = useState(DataService.facilities.getAll());
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const canSelect = [UserRole.ADMIN, UserRole.SECTION_HEAD].includes(currentUser.role);

            useEffect(() => { 
                setItems(DataService.items.getAll()); 
                setFacilities(DataService.facilities.getAll()); 
                if (!canSelect && currentUser.facilityId) setSelectedFacility(currentUser.facilityId); 
            }, [currentUser, canSelect]);

            useEffect(() => {
                setEmployees(DataService.employees.getAll().filter(e => e.facilityId === selectedFacility));
                const filtered = DataService.evaluations.getAll().filter(e => e.date.startsWith(month) && e.facilityId === selectedFacility);
                setEvaluations(filtered);
                const days = new Date(parseInt(month.split('-')[0]), parseInt(month.split('-')[1]), 0).getDate();
                const arr = []; for(let i=1; i<=days; i++) arr.push(`${month}-${String(i).padStart(2, '0')}`);
                setDaysInMonth(arr);
            }, [month, selectedFacility]);

            const getStatus = (day, item, emp) => {
                if (!isApplicable(item, emp)) return 'empty';
                const ev = evaluations.find(e => e.date === day);
                if (!ev) return 'pending';
                return ev.scores[`${item.id}_${emp.id}`] ? 'pass' : 'fail';
            };
            
            const handleExport = () => exportToPDF('monthly-eval-report', `Monthly-Eval-${month}.pdf`, 'landscape', { title: 'التقييم الشهري', facility: facilities.find(f => f.id === selectedFacility)?.name || '', date: formatMonthYearArabic(month) }, { repeatHeader: false });

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex justify-between no-print">
                        <h2 className="text-xl font-bold">التقييم الشهري</h2>
                        <div className="flex gap-2">{canSelect && <select value={selectedFacility} onChange={e => setSelectedFacility(e.target.value)} className="border p-2 rounded">{facilities.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}</select>}<input type="month" value={month} onChange={e => setMonth(e.target.value)} className="border p-2 rounded" /><button onClick={handleExport} className="bg-blue-600 text-white px-4 py-2 rounded">PDF</button></div>
                    </div>
                    <div id="monthly-eval-report" className="bg-white p-4 rounded shadow overflow-x-auto mt-6">
                        <table className="w-full text-xs text-center border-collapse border border-gray-400">
                            <thead><tr className="bg-gold text-white"><th className="border p-2">التاريخ</th><th className="border p-2">البند</th>{employees.map(e => <th key={e.id} className="border p-2">{e.name}<br/>{e.jobTitle}</th>)}</tr></thead>
                            <tbody>{daysInMonth.map(day => <Fragment key={day}>{items.map((item, idx) => (<tr key={`${day}-${item.id}`} className={idx % 2 ? 'bg-gray-50' : 'bg-white'}>{idx === 0 && <td rowSpan={items.length} className="border p-2 font-bold bg-gray-100">{day}</td>}<td className="border p-1 text-right">{item.name}</td>{employees.map(emp => { const s = getStatus(day, item, emp); return <td key={emp.id} className="border p-1">{s === 'empty' ? '' : s === 'pending' ? '-' : <i className={`fa ${s === 'pass' ? 'fa-check text-green-500' : 'fa-times text-red-500'}`}></i>}</td> })}</tr>))}</Fragment>)}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Monthly Report
        const MonthlyReportPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [facilities, setFacilities] = useState(DataService.facilities.getAll());
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const [reportData, setReportData] = useState(null);
            const [facilityDetails, setFacilityDetails] = useState(null);

            const canSelect = [UserRole.ADMIN, UserRole.SECTION_HEAD, UserRole.DEPT_MANAGER].includes(currentUser.role);

            useEffect(() => { 
                setFacilities(DataService.facilities.getAll()); 
                if (!canSelect && currentUser.facilityId) setSelectedFacility(currentUser.facilityId); 
            }, [canSelect, currentUser]);

            useEffect(() => {
                const fac = facilities.find(f => f.id === selectedFacility);
                setFacilityDetails(fac || null);

                let supervisorAbsence = 0;
                let workerAbsence = 0;
                const evals = DataService.evaluations.getAll().filter(e => e.date.startsWith(month) && e.facilityId === selectedFacility);
                const emps = DataService.employees.getAll().filter(e => e.facilityId === selectedFacility);
                
                evals.forEach(ev => {
                    emps.forEach(emp => {
                        const isPresent = ev.scores[`i1_${emp.id}`];
                        if (isPresent === false) { 
                            if (emp.jobTitle.includes('مشرف')) supervisorAbsence++;
                            else workerAbsence++;
                        }
                    });
                });

                const monthViolations = DataService.violations.getAll().filter(v => v.date.startsWith(month) && v.facilityId === selectedFacility);
                
                const safetyCount = monthViolations.filter(v => ['v8', 'v9', 'v11', 'v15', 'v16', 'v5', 'v6', 'v7', 'v10'].includes(v.violationTypeId)).length;
                const hygieneCount = monthViolations.filter(v => ['v12', 'v13', 'v14', 'v17'].includes(v.violationTypeId)).length;
                const labCount = monthViolations.filter(v => v.violationTypeId === 'v18').length; 

                setReportData({ supervisorAbsence, workerAbsence, safetyCount, hygieneCount, labCount });

            }, [month, selectedFacility, facilities]);

            const handleExport = () => {
                const element = document.getElementById('monthly-report-print');
                if (!element) return;
                const opt = { margin: 0, filename: `MonthlyReport-${month}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                if (window.html2pdf) { window.html2pdf().from(element).set(opt).save(); } else { window.print(); }
            };

            const employeesString = INVOICE_EMPLOYEE_STRUCTURE.map(e => `${e.role}`).join(' / ');

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex justify-between items-center no-print">
                        <h2 className="text-xl font-bold">التقرير الشهري</h2>
                        <div className="flex gap-2">
                            {canSelect && <select value={selectedFacility} onChange={e => setSelectedFacility(e.target.value)} className="border p-2 rounded">{facilities.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}</select>}
                            <input type="month" value={month} onChange={e => setMonth(e.target.value)} className="border p-2 rounded" />
                            <button onClick={handleExport} className="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2"><i className="fa fa-file-pdf"></i> PDF</button>
                        </div>
                    </div>

                    <div id="monthly-report-print" className="bg-white mx-auto w-full max-w-[210mm] min-h-[297mm] p-4 text-xs font-sans text-black flex flex-col relative">
                        <div className="flex justify-between items-stretch mb-1 border-2 border-[#b8860b] h-20 bg-[#c5b358]">
                             <div className="w-1/4 flex items-center justify-center p-2"></div>
                            <div className="w-1/2 flex flex-col items-center justify-center text-black font-bold">
                                <h1 className="text-xl mb-1">إدارة الصحة العامة</h1>
                                <h2 className="text-lg">مسلخ {facilityDetails?.location.split('-')[0] || '....'}</h2>
                            </div>
                            <div className="w-1/4 flex items-center justify-center p-2 border-r-2 border-[#b8860b]">
                                 {DataService.settings.get().logo ? (
                                    <img src={DataService.settings.get().logo} alt="Logo" className="max-h-16 max-w-full object-contain mix-blend-multiply" />
                                ) : <span className="text-xl font-bold">Logo</span>}
                            </div>
                        </div>

                        <div className="bg-[#8b4513] text-white text-center font-bold py-1 border-2 border-[#8b4513] mb-1">التقرير الشهري عن متعهد المسلخ</div>
                        <div className="bg-[#d2691e] text-white text-center font-bold py-1 border-2 border-[#d2691e] mb-4">عقد رقم ({facilityDetails?.contractNumber || ''})</div>

                        <div className="border-2 border-[#c5b358] mb-4">
                            <div className="bg-[#c5b358] text-right font-bold p-1 border-b border-[#c5b358]">البيانات</div>
                            <div className="flex border-b border-gray-400">
                                <div className="w-1/4 bg-gray-50 p-1 border-l border-gray-400 font-bold">مسلخ مدينة</div>
                                <div className="w-1/4 p-1 border-l border-gray-400">{facilityDetails?.location.split('-')[0]}</div>
                                <div className="w-1/4 bg-gray-50 p-1 border-l border-gray-400 font-bold">شهر</div>
                                <div className="w-1/4 p-1">{formatMonthYearArabic(month)}</div>
                            </div>
                            <div className="flex border-b border-gray-400">
                                <div className="w-1/4 bg-gray-50 p-1 border-l border-gray-400 font-bold">المشغل</div>
                                <div className="w-3/4 p-1">{facilityDetails?.operatingCompany}</div>
                            </div>
                            <div className="flex">
                                <div className="w-1/4 bg-gray-50 p-1 border-l border-gray-400 font-bold">القوة العاملة</div>
                                <div className="w-3/4 p-1 text-[10px]">{employeesString}</div>
                            </div>
                        </div>

                        <div className="border-2 border-[#c5b358] flex-1 flex flex-col">
                            <div className="bg-[#c5b358] text-right font-bold p-1 border-b border-black">مخالفات العقد</div>
                            <div className="flex bg-gray-100 font-bold text-center border-b border-black">
                                <div className="w-1/3 p-1 border-l border-black">نوع المخالفة</div>
                                <div className="w-1/6 p-1 border-l border-black">الوحدة</div>
                                <div className="w-1/6 p-1 border-l border-black">العدد</div>
                                <div className="w-1/3 p-1">ملاحظات</div>
                            </div>
                            <div className="flex border-b border-black">
                                <div className="w-1/3 p-2 border-l border-black font-bold">غياب مشرف العمال</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">يوم</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">{reportData?.supervisorAbsence || '-'}</div>
                                <div className="w-1/3 p-2 text-center"></div>
                            </div>
                            <div className="flex border-b border-black">
                                <div className="w-1/3 p-2 border-l border-black font-bold">غياب (محاسب - قصاب - عامل نظافة - عامل جلود - حمال)</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">عامل / يوم</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">{reportData?.workerAbsence || '-'}</div>
                                <div className="w-1/3 p-2 text-center"></div>
                            </div>
                            <div className="flex border-b border-black">
                                <div className="w-1/3 p-2 border-l border-black font-bold">مخالفة شروط الصحة والسلامة المهنية</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">يوم</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">{reportData?.safetyCount || '-'}</div>
                                <div className="w-1/3 p-2 text-center"></div>
                            </div>
                            <div className="flex border-b border-black">
                                <div className="w-1/3 p-2 border-l border-black font-bold">مخالفة النظافة والتطهير</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">يوم</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">{reportData?.hygieneCount || '-'}</div>
                                <div className="w-1/3 p-2 text-center"></div>
                            </div>
                            <div className="flex border-b border-black">
                                <div className="w-1/3 p-2 border-l border-black font-bold">تقرير الفحص المخبري</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">سلبي</div>
                                <div className="w-1/6 p-2 border-l border-black text-center">{reportData?.labCount > 0 ? 'إيجابي' : '-'}</div>
                                <div className="w-1/3 p-2 text-center"></div>
                            </div>
                        </div>

                        <div className="mt-8 border-2 border-black">
                            <div className="flex border-b border-black">
                                <div className="w-1/2 text-center p-1 border-l border-black font-bold bg-gray-50">ممثل الشركة</div>
                                <div className="w-1/2 text-center p-1 font-bold bg-gray-50">الطبيب البيطري</div>
                            </div>
                            <div className="flex h-16">
                                <div className="w-1/2 border-l border-black p-2"></div>
                                <div className="w-1/2 p-2 text-center flex items-end justify-center font-bold">{currentUser.name}</div>
                            </div>
                            <div className="text-center p-1 font-bold bg-gray-50 border-t border-b border-black">رئيس شعبة المسالخ</div>
                            <div className="h-16"></div>
                        </div>

                        <div className="mt-auto bg-[#c5b358] flex justify-between px-4 py-1 font-bold border-t-2 border-[#8b4513]">
                            <span>SH-KPI</span>
                            <span>نسخة الكترونية معتمدة</span>
                            <span>Page 1-1</span>
                        </div>
                    </div>
                </div>
            );
        };

        // KPI Page
        const KPIPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const [stats, setStats] = useState({});
            const [status, setStatus] = useState(null);
            const [items, setItems] = useState([]);
            const [notes, setNotes] = useState({});
            const [facilities, setFacilities] = useState([]);
            const [contractNumber, setContractNumber] = useState('');
            const [paymentNumber, setPaymentNumber] = useState(''); 
            const [slaughterhouseName, setSlaughterhouseName] = useState('');

            const showFacilities = [UserRole.ADMIN, UserRole.DEPT_MANAGER].includes(currentUser.role);
            const canEdit = [UserRole.ADMIN, UserRole.USER].includes(currentUser.role) && (!status || !status.submittedForApproval);
            const canApprove = currentUser.role === UserRole.DEPT_MANAGER && status?.submittedForApproval && !status.approvedByManager;

            useEffect(() => {
                setItems(DataService.items.getAll());
                setFacilities(DataService.facilities.getAll());
                if (!showFacilities && currentUser.facilityId) setSelectedFacility(currentUser.facilityId);
            }, [showFacilities, currentUser]);

            useEffect(() => {
                const fac = DataService.facilities.getAll().find(f => f.id === selectedFacility);
                if (fac) { setSlaughterhouseName(fac.name); setContractNumber(fac.contractNumber); }
                const inv = DataService.invoices.getAll().find(i => i.month === month && i.facilityId === selectedFacility);
                setPaymentNumber(inv?.paymentNumber || `PAY-${month}`);
                const r = DataService.kpiReports.getAll().find(r => r.month === month && r.facilityId === selectedFacility);
                setStatus(r || null);
                if(r) setNotes(r.notes || {}); else setNotes({});
                
                const evals = DataService.evaluations.getAll().filter(e => e.date.startsWith(month) && e.facilityId === selectedFacility);
                const iStats = {};
                items.forEach(item => {
                    let iT = 0, iP = 0;
                    evals.forEach(ev => { Object.keys(ev.scores).forEach(k => { if (k.startsWith(`${item.id}_`)) { iT++; if(ev.scores[k]) iP++; } }); });
                    iStats[item.id] = { total: iT, passed: iP, percentage: iT === 0 ? 100 : Math.round((iP/iT)*100) };
                });
                setStats(iStats);
            }, [month, selectedFacility, items]);

            const handleSubmit = () => { 
                const d = { id: `${month}-${selectedFacility}`, month, facilityId: selectedFacility, notes, approvedByManager: false, submittedForApproval: true }; 
                DataService.kpiReports.save([...DataService.kpiReports.getAll().filter(r => r.id !== d.id), d]); 
                setStatus(d); showToast('تم التقديم'); 
            };
            const handleApprove = () => { if(status) { const d = {...status, approvedByManager: true}; DataService.kpiReports.save([...DataService.kpiReports.getAll().filter(r => r.id !== d.id), d]); setStatus(d); showToast('تم الاعتماد'); }};
            const handleExport = () => {
                const element = document.getElementById('kpi-report');
                if (!element) return;
                const opt = { margin: 0, filename: `KPI-${month}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                if (window.html2pdf) { window.html2pdf().from(element).set(opt).save(); } else { window.print(); }
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex flex-wrap gap-4 justify-between items-center no-print">
                        <h2 className="text-xl font-bold">مؤشر الأداء</h2>
                        <div className="flex gap-2 items-center">
                            {showFacilities && (<select value={selectedFacility} onChange={e => setSelectedFacility(e.target.value)} className="border p-2 rounded">{facilities.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}</select>)}
                            <input type="month" value={month} onChange={e => setMonth(e.target.value)} className="border p-2 rounded" />
                            {canEdit && <button onClick={handleSubmit} className="bg-green-600 text-white px-4 py-2 rounded font-bold">تقديم</button>}
                            {canApprove && <button onClick={handleApprove} className="bg-gold hover:bg-gold-dark text-white px-4 py-2 rounded font-bold">اعتماد</button>}
                            <button onClick={handleExport} className="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2"><i className="fa fa-file-pdf"></i> PDF</button>
                        </div>
                    </div>

                    <div id="kpi-report" className="bg-white mx-auto w-full max-w-[210mm] min-h-[297mm] p-4 text-xs font-sans text-black relative flex flex-col">
                        <div className="flex justify-between items-stretch mb-2 border-2 border-[#8b4513] h-24">
                             <div className="w-1/4 border-l-2 border-[#8b4513] flex items-center justify-center p-2"></div>
                            <div className="w-1/2 flex flex-col items-center justify-center bg-[#c5b358] text-black font-bold">
                                <h1 className="text-xl mb-1">إدارة الصحة العامة</h1>
                                <h2 className="text-lg">مسلخ {slaughterhouseName}</h2>
                            </div>
                            <div className="w-1/4 border-r-2 border-[#8b4513] flex items-center justify-center p-2">
                                 {DataService.settings.get().logo ? (
                                    <img src={DataService.settings.get().logo} alt="Logo" className="max-h-20 max-w-full object-contain mix-blend-multiply" />
                                ) : <span className="text-xl font-bold">Logo</span>}
                            </div>
                        </div>

                        <div className="bg-[#8b4513] text-white text-center font-bold py-1 border-2 border-[#8b4513] mb-2">المؤشرات الرئيسية للأداء</div>
                        <div className="border-2 border-black text-center font-bold py-1 mb-2">تقدم شهرياً إلى إدارة المحاسبة مع نسخة إلى إدارة المشتريات والمناقصات والعقود</div>

                        <div className="flex border-2 border-[#c5b358] mb-4 font-bold text-center">
                            <div className="w-1/2 flex"><div className="bg-[#c5b358] w-1/3 py-1 border-l border-white">رقم العقد</div><div className="w-2/3 py-1 bg-[#fdf5e6]">{contractNumber}</div></div>
                            <div className="w-1/2 flex"><div className="bg-[#c5b358] w-1/3 py-1 border-r border-white">رقم الفاتورة الضريبية</div><div className="w-2/3 py-1 bg-[#fdf5e6]">{paymentNumber}</div></div>
                        </div>

                        <div className="border-2 border-black flex-1 flex flex-col">
                            <div className="bg-[#c5b358] text-black font-bold border-b-2 border-black">
                                <div className="text-right px-2 py-1 bg-[#e6d89b] border-b border-black">البيانات</div>
                                 <div className="flex border-b border-black">
                                    <div className="w-1/2 border-l border-black p-1 text-center bg-white">مسلخ مدينة {DataService.facilities.getAll().find(f=>f.id===selectedFacility)?.location.split('-')[0] || ''}</div>
                                    <div className="w-1/2 p-1 text-center bg-white">مؤشرات الأداء للمقاول شهر {formatMonthYearArabic(month)}</div>
                                </div>
                                <div className="text-right px-2 py-1 bg-[#f0f0f0] border-b border-black text-[10px]">معايير تقييم الأداء: (ممتاز: 95-100) (جيد جداً: 90-94) (جيد: 80-89) (مقبول: 70-79) (ضعيف: أقل من 70)</div>
                            </div>

                            <div className="flex flex-1">
                                <div className="flex flex-col w-[45%] border-l border-gray-300">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white">البند</div>
                                    {items.map((item, index) => (<div key={item.id} className={`flex-1 flex items-center justify-start pr-2 font-bold text-right border-b border-gray-300 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>{item.name}</div>))}
                                </div>
                                <div className="flex flex-col w-[10%] border-l border-gray-300">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white">حساب التقييم</div>
                                    <div className="flex-1 flex items-center justify-center bg-[#fdf5e6]"><span className="text-xs text-gray-600 font-bold whitespace-nowrap transform rotate-90" style={{ writingMode: 'vertical-rl', textOrientation: 'mixed' }}>الالتزام الفعلي / المطلوب %</span></div>
                                </div>
                                <div className="flex flex-col w-[8%] border-l border-gray-300">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white">العدد</div>
                                    {items.map((item, index) => { const s = stats[item.id] || {total: 0}; return (<div key={item.id} className={`flex-1 flex items-center justify-center border-b border-gray-300 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>{s.total}</div>); })}
                                </div>
                                <div className="flex flex-col w-[8%] border-l border-gray-300">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white">المطابق</div>
                                    {items.map((item, index) => { const s = stats[item.id] || {passed: 0}; return (<div key={item.id} className={`flex-1 flex items-center justify-center border-b border-gray-300 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>{s.passed}</div>); })}
                                </div>
                                <div className="flex flex-col w-[8%] border-l border-gray-300">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white">%</div>
                                    {items.map((item, index) => { const s = stats[item.id] || {percentage: 100}; return (<div key={item.id} className={`flex-1 flex items-center justify-center font-bold border-b border-gray-300 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`} dir="ltr">{s.percentage}%</div>); })}
                                </div>
                                <div className="flex flex-col w-[21%]">
                                    <div className="h-10 bg-[#c5b358] text-white flex items-center justify-center font-bold border-b border-white">ملاحظات</div>
                                    {items.map((item, index) => (<div key={item.id} className={`flex-1 flex items-center justify-center p-1 border-b border-gray-300 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}><input className="w-full text-center bg-transparent outline-none text-[10px]" value={notes[item.id] || ''} onChange={e => setNotes({...notes, [item.id]: e.target.value})} readOnly={!!status?.approvedByManager}/></div>))}
                                </div>
                            </div>
                        </div>

                        <div className="mt-4 flex justify-between items-end px-8 pb-4">
                             <div className="text-center"><div className="font-bold mb-8 border-b-2 border-black pb-1 min-w-[150px]">الطبيب المناوب</div><div>{status?.submittedForApproval ? currentUser.name : '...................'}</div></div>
                            <div className="text-center"><div className="font-bold mb-8 border-b-2 border-black pb-1 min-w-[150px]">ممثل المقاول</div><div>...................</div></div>
                            <div className="text-center"><div className="font-bold mb-8 border-b-2 border-black pb-1 min-w-[150px]">مدير الإدارة</div><div>{status?.approvedByManager ? 'معتمد' : '...................'}</div></div>
                        </div>

                        <div className="mt-auto bg-[#c5b358] flex justify-between px-4 py-1 font-bold border-t-2 border-[#8b4513]"><span>SH-KPI</span><span>نسخة الكترونية معتمدة</span><span>Page 1-1</span></div>
                    </div>
                </div>
            );
        };

        // Invoice - LANDSCAPE
        const MonthlyInvoicePage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [selectedFacility, setSelectedFacility] = useState(currentUser.facilityId || '1');
            const [invoiceData, setInvoiceData] = useState(null);
            const [facilities, setFacilities] = useState(DataService.facilities.getAll());
            const [calculatedData, setCalculatedData] = useState(null);
            const [contractNumber, setContractNumber] = useState('');
            const [paymentNumber, setPaymentNumber] = useState('');
            const [operatingCompany, setOperatingCompany] = useState('');
            const [slaughterhouseName, setSlaughterhouseName] = useState('');
            const canSelect = [UserRole.ADMIN, UserRole.DEPT_MANAGER, UserRole.SECTION_HEAD].includes(currentUser.role);
            
            useEffect(() => {
                setFacilities(DataService.facilities.getAll());
                if (!canSelect && currentUser.facilityId) setSelectedFacility(currentUser.facilityId);
            }, [currentUser, canSelect]);

            useEffect(() => {
                const selectedFacilityData = facilities.find(f => f.id === selectedFacility);
                if (selectedFacilityData) {
                    setContractNumber(selectedFacilityData.contractNumber || '');
                    setOperatingCompany(selectedFacilityData.operatingCompany || '');
                    setSlaughterhouseName(selectedFacilityData.name || '');
                }
                const invoice = DataService.invoices.getAll().find(i => i.month === month && i.facilityId === selectedFacility);
                setInvoiceData(invoice || null);
                if (invoice && invoice.data) {
                    setCalculatedData(invoice.data);
                    setPaymentNumber(invoice.paymentNumber || '');
                    setContractNumber(invoice.contractNumber || '');
                    setOperatingCompany(invoice.operatingCompany || '');
                    return;
                }

                // Live Calc
                const [yearStr, monthStr] = month.split('-');
                const daysInMonth = new Date(parseInt(yearStr), parseInt(monthStr), 0).getDate();
                const v = DataService.violations.getAll().filter(v => v.date.startsWith(month) && v.facilityId === selectedFacility).reduce((s, v) => s + v.total, 0);
                const violationsTotal = v;
                const evals = DataService.evaluations.getAll().filter(e => e.date.startsWith(month) && e.facilityId === selectedFacility);
                let t = 0, p = 0; evals.forEach(e => Object.values(e.scores).forEach(x => { t++; if(x) p++; }));
                const kpiPercentage = t === 0 ? 100 : Math.round((p/t)*100);
                const allExtra = DataService.extraLabor.getAll();
                const extra = allExtra.find(e => e.date === month && e.facilityId === selectedFacility && e.submitted);
                const extraLaborCost = extra ? extra.items.reduce((sum, item) => sum + (item.dailyRate * item.days), 0) : 0;
                const extraLaborItems = extra ? extra.items.filter(i => i.days > 0 || i.dailyRate > 0) : [];

                const facilityEmployees = DataService.employees.getAll().filter(e => e.facilityId === selectedFacility);
                const roleStats = {};
                INVOICE_EMPLOYEE_STRUCTURE.forEach(s => { roleStats[s.role] = { present: 0, absent: 0 }; });
                evals.forEach(ev => {
                    facilityEmployees.forEach(emp => {
                        const role = emp.jobTitle.trim();
                        const structMatch = INVOICE_EMPLOYEE_STRUCTURE.find(s => s.role === role);
                        if (structMatch) {
                            const isPresent = ev.scores[`i1_${emp.id}`];
                            if (isPresent === true) roleStats[structMatch.role].present++;
                            else if (isPresent === false) roleStats[structMatch.role].absent++;
                        }
                    });
                });

                const employeeCosts = INVOICE_EMPLOYEE_STRUCTURE.map(item => {
                    const dailySalary = item.monthlySalary / daysInMonth; 
                    const totalExpectedDays = item.count * daysInMonth; 
                    const actualDays = roleStats[item.role]?.present || 0;
                    const absentDays = roleStats[item.role]?.absent || 0;
                    const netSalary = actualDays * dailySalary;
                    const isSupervisor = item.role === 'مشرف المسلخ' || item.role === 'مشرف النظافة';
                    const penaltyRate = isSupervisor ? 250 : 150;
                    const absentPenalty = absentDays * penaltyRate;
                    return { ...item, dailySalary, expectedDays: daysInMonth, totalExpectedDays, actualDays, absentDays, netSalary, absentPenalty };
                });

                const totalSalaries = employeeCosts.reduce((sum, item) => sum + item.netSalary, 0);
                const totalAbsentPenalties = employeeCosts.reduce((sum, item) => sum + item.absentPenalty, 0);
                const baseTotal = totalSalaries + CLEANING_MATERIAL_COST + extraLaborCost;
                let kpiDeduction = 0;
                if (kpiPercentage < 80) kpiDeduction = baseTotal * 0.10;
                else if (kpiPercentage < 90) kpiDeduction = baseTotal * 0.05;
                const retention = baseTotal * 0.05; 
                const tax = baseTotal * 0.05; 
                const finalTotal = (baseTotal + tax) - (violationsTotal + totalAbsentPenalties + kpiDeduction + retention);

                setCalculatedData({ employeeCosts, baseTotal, tax, kpiDeduction, violationsTotal, totalAbsentPenalties, retention, finalTotal, extraLaborCost, kpiPercentage, extraLaborItems, daysInMonth });
            }, [month, selectedFacility, facilities]);

            const handleUserSubmit = () => { 
                if (!calculatedData) return;
                const d = { id: `${month}-${selectedFacility}`, month, facilityId: selectedFacility, status: 'SUBMITTED', approvals: {}, signatures: { enteredBy: currentUser.name, enteredDate: new Date().toLocaleDateString('en-GB') }, contractNumber, paymentNumber: paymentNumber || `PAY-${month}-${selectedFacility}`, operatingCompany, slaughterhouseName, data: calculatedData }; 
                DataService.invoices.save([...DataService.invoices.getAll().filter(i => i.id !== d.id), d]); setInvoiceData(d); showToast('تم تقديم الفاتورة بنجاح'); 
            };
            const handleContractorApprove = () => { if(invoiceData) { const d = {...invoiceData, approvals: {...invoiceData.approvals, contractor: true}, signatures: {...invoiceData.signatures, contractor: currentUser.name, contractorDate: new Date().toLocaleDateString('en-GB')}}; DataService.invoices.save([...DataService.invoices.getAll().filter(i=>i.id!==d.id), d]); setInvoiceData(d); showToast('تم اعتماد المقاول'); } };
            const handleManagerApprove = () => { if(invoiceData) { const d = {...invoiceData, status: 'APPROVED', approvals: {...invoiceData.approvals, deptManager: true}, signatures: {...invoiceData.signatures, deptManager: currentUser.name, deptManagerDate: new Date().toLocaleDateString('en-GB')}}; DataService.invoices.save([...DataService.invoices.getAll().filter(i=>i.id!==d.id), d]); setInvoiceData(d); showToast('تم الاعتماد النهائي'); } };
            const handleExport = () => {
                const element = document.getElementById('invoice-report');
                if(element && window.html2pdf) { const opt = { margin: 0, filename: `Invoice-${month}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } }; window.html2pdf().from(element).set(opt).save(); } else window.print();
            };

            const isUser = currentUser.role === UserRole.USER || currentUser.role === UserRole.ADMIN;
            if (!calculatedData) return <div>جاري التحميل...</div>;
            const { employeeCosts, baseTotal, tax, kpiDeduction, violationsTotal, totalAbsentPenalties, retention, finalTotal, extraLaborCost, kpiPercentage, extraLaborItems, daysInMonth } = calculatedData;
            const totalImposedPenalties = totalAbsentPenalties + violationsTotal;

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex flex-col gap-4 no-print border-b border-gray-200">
                        <div className="flex flex-wrap gap-4 items-center">
                            <h2 className="text-xl font-bold flex-1 text-gray-800">إدارة الفواتير</h2>
                            {canSelect && (<select value={selectedFacility} onChange={e => setSelectedFacility(e.target.value)} className="border p-2 rounded bg-gray-50">{facilities.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}</select>)}
                            <input type="month" value={month} onChange={e => setMonth(e.target.value)} className="border p-2 rounded bg-gray-50" />
                            {isUser && (<div className="flex flex-wrap gap-2"><input type="text" value={contractNumber} onChange={e => setContractNumber(e.target.value)} placeholder="رقم العقد" className="border p-2 rounded w-32 text-sm" /><input type="text" value={paymentNumber} onChange={e => setPaymentNumber(e.target.value)} placeholder="رقم الدفعة" className="border p-2 rounded w-32 text-sm" /></div>)}
                            {isUser && (!invoiceData || invoiceData.status === 'PENDING') && (<button onClick={handleUserSubmit} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm text-sm font-bold">تقديم للاعتماد</button>)}
                            {invoiceData && !invoiceData.approvals.contractor && currentUser.role === UserRole.CONTRACTOR && (<button onClick={handleContractorApprove} className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded shadow-sm text-sm font-bold">اعتماد مقاول</button>)}
                            {invoiceData && !invoiceData.approvals.deptManager && currentUser.role === UserRole.DEPT_MANAGER && (<button onClick={handleManagerApprove} className="bg-gold hover:bg-gold-dark text-white px-4 py-2 rounded shadow-sm text-sm font-bold">اعتماد نهائي</button>)}
                            <button onClick={handleExport} className="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded shadow-sm text-sm font-bold flex items-center gap-2"><i className="fa fa-file-pdf"></i> تصدير PDF</button>
                        </div>
                    </div>
                    
                    <div id="invoice-report" className="bg-white p-2 mx-auto w-full max-w-[297mm] h-[210mm] flex flex-col justify-between text-[10px] leading-tight font-sans overflow-hidden">
                        <div>
                            <div className="flex justify-between items-center bg-[#c5b358] p-1 border-2 border-black mb-1 h-[18mm]">
                                <div className="text-center w-1/4 h-full flex items-center justify-center">{DataService.settings.get().logo ? (<img src={DataService.settings.get().logo} alt="Logo" className="h-full max-h-16 mx-auto object-contain mix-blend-multiply" />) : <div className="text-2xl font-bold">LOGO</div>}</div>
                                <div className="text-center w-2/4"><h1 className="text-xl font-bold mb-0">إدارة الصحة العامة</h1><h2 className="text-lg font-bold">مسلخ {slaughterhouseName || '................'}</h2></div>
                                 <div className="text-center w-1/4"></div>
                            </div>
                            <div className="grid grid-cols-3 border-2 border-black mb-1 text-center font-bold text-[10px]">
                                <div className="border-l-2 border-black bg-[#e6d89b] p-0.5">المشروع : تشغيل وصيانة المسالخ</div>
                                <div className="border-l-2 border-black bg-[#e6d89b] p-0.5">الشركة المشغلة : {operatingCompany}</div>
                                <div className="bg-[#e6d89b] p-0.5">عقد رقم : {contractNumber}</div>
                                <div className="border-t-2 border-l-2 border-black bg-[#e6d89b] p-0.5">الدفعة رقم : {paymentNumber}</div>
                                <div className="border-t-2 border-l-2 border-black bg-[#e6d89b] p-0.5">عن شهر : {formatMonthYearArabic(month)}</div>
                                <div className="border-t-2 border-black bg-[#e6d89b] p-0.5">التاريخ : {invoiceData?.signatures.enteredDate || new Date().toLocaleDateString('en-GB')}</div>
                            </div>
                            <table className="w-full border-collapse border-2 border-black text-center text-[10px] mb-1">
                                <thead className="bg-[#c5b358] text-black font-bold"><tr><th className="border border-black p-0.5 w-6">م</th><th className="border border-black p-0.5 w-32">الفئة</th><th className="border border-black p-0.5">عدد العمالة</th><th className="border border-black p-0.5">الراتب الشهري</th><th className="border border-black p-0.5">التكلفة الشهرية</th><th className="border border-black p-0.5">الراتب اليومي</th><th className="border border-black p-0.5">عدد أيام الشهر</th><th className="border border-black p-0.5">إجمالي عدد أيام<br/>الحضور المتوقعة</th><th className="border border-black p-0.5">أيام الغياب</th><th className="border border-black p-0.5">عدد أيام الحضور<br/>الفعلي للموظف</th><th className="border border-black p-0.5 w-24">الراتب المستحق</th></tr></thead>
                                <tbody>
                                    {employeeCosts.map((item, index) => (<tr key={index}><td className="border border-black p-0.5">{index + 1}</td><td className="border border-black p-0.5 font-bold bg-white text-right px-1">{item.role}</td><td className="border border-black p-0.5">{item.count}</td><td className="border border-black p-0.5">{Math.round(item.monthlySalary).toLocaleString()}</td><td className="border border-black p-0.5">{(Math.round(item.count * item.monthlySalary)).toLocaleString()}</td><td className="border border-black p-0.5">{item.dailySalary.toFixed(2)}</td><td className="border border-black p-0.5">{daysInMonth}</td><td className="border border-black p-0.5">{item.totalExpectedDays}</td><td className="border border-black p-0.5 bg-white font-bold text-red-600">{item.absentDays}</td><td className="border border-black p-0.5">{item.actualDays}</td><td className="border border-black p-0.5 font-bold bg-[#fef3c7]">{Math.round(item.netSalary).toLocaleString()}</td></tr>))}
                                    <tr className="bg-gray-50"><td className="border border-black p-0.5">{employeeCosts.length + 1}</td><td className="border border-black p-0.5 font-bold text-right px-1">معدات ومواد التنظيف والتطهير</td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 font-bold bg-[#fef3c7]">{CLEANING_MATERIAL_COST.toLocaleString()}</td></tr>
                                    <tr className="bg-[#e6d89b] font-bold"><td className="border border-black p-0.5" colSpan={10}>مجموع الرواتب الشهرية ومعدات ومواد التنظيف</td><td className="border border-black p-0.5">{(Math.round(calculatedData.employeeCosts.reduce((s, i) => s + i.netSalary, 0)) + CLEANING_MATERIAL_COST).toLocaleString()}</td></tr>
                                    {extraLaborItems && extraLaborItems.map((item, i) => (<tr key={`extra-${i}`}><td className="border border-black p-0.5">{employeeCosts.length + 2 + i}</td><td className="border border-black p-0.5 font-bold text-right px-1">{item.jobTitle} (إضافي)</td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5">{item.dailyRate}</td><td className="border border-black p-0.5">{item.days}</td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 bg-gray-200"></td><td className="border border-black p-0.5 font-bold bg-[#fef3c7]">{(item.dailyRate * item.days).toLocaleString()}</td></tr>))}
                                     <tr className="bg-[#e6d89b] font-bold"><td className="border border-black p-0.5" colSpan={10}>مجموع خدمات العمالة الاضافية</td><td className="border border-black p-0.5">{extraLaborCost.toLocaleString()}</td></tr>
                                    <tr className="bg-[#c5b358] font-bold text-[11px]"><td className="border border-black p-0.5" colSpan={10}>اجمالي قيمة الخدمات خلال الشهر</td><td className="border border-black p-0.5">{Math.round(baseTotal).toLocaleString()}</td></tr>
                                </tbody>
                            </table>
                            <table className="w-full border-collapse border-2 border-black text-center text-[10px] mb-2">
                                <tbody>
                                    <tr><td className="border border-black p-0.5 bg-[#fce7f3] font-bold w-[70%] text-right px-2">حجز (5%) من قيمة الفاتورة تأمين "كفالة حسن تنفيذ الأعمال" = ( المبلغ الخاضع للضريبة * 5% )</td><td className="border border-black p-0.5 bg-white font-bold w-[15%] text-red-600">({Math.round(retention).toLocaleString()})</td><td className="border border-black p-0.5 bg-white w-[15%]"></td></tr>
                                    <tr><td className="border border-black p-0.5 bg-gray-50 font-bold text-right px-2">المبلغ الإجمالي الخاضع للضريبة = (إجمالي قيمة الخدمات خلال الشهر)</td><td className="border border-black p-0.5 bg-white"></td><td className="border border-black p-0.5 bg-white font-bold">{Math.round(baseTotal).toLocaleString()}</td></tr>
                                     <tr><td className="border border-black p-0.5 bg-gray-50 font-bold text-right px-2">مبلغ الضريبة 5% = (المبلغ الخاضع للضريبة 5%)</td><td className="border border-black p-0.5 bg-white"></td><td className="border border-black p-0.5 bg-white font-bold">{Math.round(tax).toLocaleString()}</td></tr>
                                    <tr>
                                        <td className="border border-black p-0" colSpan={3}>
                                            <div className="flex">
                                                <div className="w-[30%] border-l border-black flex items-center justify-center font-bold bg-white p-1">مؤشر الأداء الشهري = <span className="text-sm mx-2">{kpiPercentage}%</span></div>
                                                <div className="w-[70%]">
                                                    <div className="border-b border-black p-0.5 text-right px-2 flex justify-between bg-white"><span>مؤشر الأداء الشهري بين 90% الى 100% ( لايتم فرض أي غرامات)</span>{kpiPercentage >= 90 && <i className="fa fa-check text-green-600"></i>}</div>
                                                    <div className="border-b border-black p-0.5 text-right px-2 flex justify-between bg-white"><span>مؤشر الأداء الشهري بين 80% الى 89% ( يتم فرض غرامة 5% من قيمة الفاتورة الشهرية)</span>{kpiPercentage >= 80 && kpiPercentage < 90 && <i className="fa fa-check text-red-600"></i>}</div>
                                                    <div className="p-0.5 text-right px-2 flex justify-between bg-white"><span>مؤشر الأداء الشهري أقل من 80% (يتم فرض غرامة 10% من قيمة الفاتورة الشهرية)</span>{kpiPercentage < 80 && <i className="fa fa-check text-red-600"></i>}</div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                     <tr><td className="border border-black p-0.5 bg-white font-bold text-right px-2">إجمالي الغرامات المفروضة على المشغل</td><td className="border border-black p-0.5 font-bold text-red-600">({totalImposedPenalties.toLocaleString()})</td><td className="border border-black p-0.5 bg-gray-200"></td></tr>
                                    <tr className="bg-[#c5b358] border-2 border-black font-bold text-[11px]"><td className="border border-black p-1 text-center" colSpan={2}>الإجمالي المستحق للشهر = المبلغ الإجمالي للخدمات + الضريبة - الغرامات والجزاءات</td><td className="border border-black p-1">{Math.round(finalTotal).toLocaleString()}</td></tr>
                                    <tr className="bg-white border-2 border-black font-bold text-[11px]"><td className="border border-black p-1 text-center" colSpan={3}>{numberToArabicText(Math.floor(finalTotal))}</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div className="mt-auto">
                            <div className="flex justify-between items-start mb-2 px-6">
                                <div className="text-center"><div className="font-bold border border-black px-2 py-0.5 mb-4 bg-white min-w-[140px] shadow-sm">مدير الإدارة</div><div className="font-bold font-cairo text-base">{invoiceData?.signatures.deptManager}</div><div className="text-[10px] text-gray-500">{invoiceData?.signatures.deptManagerDate}</div></div>
                                 <div className="text-center"><div className="font-bold border border-black px-2 py-0.5 mb-4 bg-white min-w-[140px] shadow-sm">ممثل المقاول</div><div className="font-bold font-cairo text-base">{invoiceData?.signatures.contractor}</div><div className="text-[10px] text-gray-500">{invoiceData?.signatures.contractorDate}</div></div>
                                 <div className="text-center"><div className="font-bold border border-black px-2 py-0.5 mb-4 bg-white min-w-[140px] shadow-sm">الطبيب المناوب</div><div className="font-bold font-cairo text-base">{invoiceData?.signatures.enteredBy}</div><div className="text-[10px] text-gray-500">{invoiceData?.signatures.enteredDate}</div></div>
                            </div>
                             <div className="flex justify-between items-center bg-[#c5b358] p-0.5 font-bold border-2 border-black text-[9px]"><span>SH-KPI</span><span>نسخة الكترونية معتمدة</span><span>Page 1-1</span></div>
                        </div>
                   </div>
                </div>
            );
        };

        // Extra Labor
        const ExtraLaborPage = ({ currentUser }) => {
            const { showToast } = useToast();
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [rows, setRows] = useState(Array(12).fill(null).map((_, i) => ({ id: `el-${i}`, employeeName: '', jobTitle: '', dailyRate: 0, days: 0 })));
            const [submitted, setSubmitted] = useState(false);

            useEffect(() => {
                const all = DataService.extraLabor.getAll();
                const existing = all.find(e => e.date === month && e.facilityId === (currentUser.facilityId || '1'));
                if (existing) { setRows(existing.items); setSubmitted(existing.submitted); }
                else { setRows(Array(12).fill(null).map((_, i) => ({ id: `el-${i}`, employeeName: '', jobTitle: '', dailyRate: 0, days: 0 }))); setSubmitted(false); }
            }, [month, currentUser]);

            const updateRow = (idx, field, value) => { if (submitted) return; const newRows = [...rows]; newRows[idx] = { ...newRows[idx], [field]: value }; setRows(newRows); };
            const handleSubmit = () => {
                const data = { id: `${month}-${currentUser.facilityId}`, date: month, facilityId: currentUser.facilityId || '1', items: rows, submitted: true, approvedBy: currentUser.name };
                const all = DataService.extraLabor.getAll(); const existingIdx = all.findIndex(e => e.id === data.id);
                if (existingIdx >= 0) all[existingIdx] = data; else all.push(data);
                DataService.extraLabor.save(all); setSubmitted(true); showToast('تم الاعتماد');
            };

            const grandTotal = rows.reduce((sum, r) => sum + (r.dailyRate * r.days), 0);
            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded shadow flex justify-between items-center no-print"><h2 className="text-xl font-bold">العمالة الإضافية</h2><input type="month" value={month} onChange={(e) => setMonth(e.target.value)} className="border p-2 rounded"/></div>
                    <div className="bg-white p-6 rounded shadow mt-6">
                        <table className="w-full border-collapse border border-gray-300">
                            <thead><tr className="bg-gray-100"><th className="border p-2 w-12">#</th><th className="border p-2">اسم الموظف</th><th className="border p-2">الوظيفة</th><th className="border p-2 w-24">الأجر</th><th className="border p-2 w-24">الأيام</th><th className="border p-2 w-32">الاجمالي</th></tr></thead>
                            <tbody>
                                {rows.map((row, idx) => (<tr key={idx}><td className="border p-2 text-center">{idx + 1}</td><td className="border p-2"><input className="w-full p-1 border-b focus:border-gold outline-none" value={row.employeeName} onChange={(e) => updateRow(idx, 'employeeName', e.target.value)} disabled={submitted}/></td><td className="border p-2"><input className="w-full p-1 border-b focus:border-gold outline-none" value={row.jobTitle} onChange={(e) => updateRow(idx, 'jobTitle', e.target.value)} disabled={submitted}/></td><td className="border p-2"><input type="number" className="w-full p-1 border-b text-center outline-none" value={row.dailyRate || ''} onChange={(e) => updateRow(idx, 'dailyRate', Number(e.target.value))} disabled={submitted}/></td><td className="border p-2"><input type="number" className="w-full p-1 border-b text-center outline-none" value={row.days || ''} onChange={(e) => updateRow(idx, 'days', Number(e.target.value))} disabled={submitted}/></td><td className="border p-2 text-center font-bold bg-gray-50">{(row.dailyRate * row.days).toLocaleString()}</td></tr>))}
                                <tr className="bg-gold text-white font-bold text-lg"><td colSpan={5} className="border p-3 text-center">إجمالي الأجور</td><td className="border p-3 text-center">{grandTotal.toLocaleString()}</td></tr>
                            </tbody>
                        </table>
                        {!submitted && <div className="mt-4 text-left"><button onClick={handleSubmit} className="bg-gold hover:bg-gold-dark text-white px-6 py-2 rounded">اعتماد البيانات</button></div>}
                    </div>
                </div>
            );
        };

        // Settings - with Tabs
        const SettingsPage = () => {
            const { showToast } = useToast();
            const [users, setUsers] = useState(DataService.users.getAll());
            const [newUser, setNewUser] = useState({ role: UserRole.USER });
            const [employees, setEmployees] = useState(DataService.employees.getAll());
            const [newEmp, setNewEmp] = useState({});
            const [items, setItems] = useState(DataService.items.getAll());
            const [newItem, setNewItem] = useState({ category: 'ADMIN' });
            const [violations, setViolations] = useState(DataService.violationTypes.getAll());
            const [newViolation, setNewViolation] = useState({});
            const [activeTab, setActiveTab] = useState('FACILITIES');
            const [logo, setLogo] = useState(DataService.settings.get().logo || null);
            const [facilities, setFacilities] = useState(DataService.facilities.getAll());
            const [newFacility, setNewFacility] = useState({ contractNumber: '', operatingCompany: '', location: '', phone: '', email: '' });
            const [editingFacility, setEditingFacility] = useState(null);
            
            const handleFile = (e, type) => { const file = e.target.files?.[0]; if(file){ const r = new FileReader(); r.onloadend=()=>{ if(type==='logo'){setLogo(r.result); DataService.settings.save({...DataService.settings.get(), logo: r.result});} }; r.readAsDataURL(file); } };
            const addUser = () => { if(!newUser.id)return; const u = [...users.filter(u=>u.id!==newUser.id), newUser]; setUsers(u); DataService.users.save(u); showToast('تم الحفظ'); };
            const addEmp = () => { if(!newEmp.name)return; const e = {...newEmp, id: `e${Date.now()}`}; const u = [...employees, e]; setEmployees(u); DataService.employees.save(u); };
            const addItem = () => { if(!newItem.name)return; const i = {...newItem, id: `i${Date.now()}`}; const u = [...items, i]; setItems(u); DataService.items.save(u); };
            const addViol = () => { if(!newViolation.name)return; const v = {...newViolation, id: `v${Date.now()}`}; const u = [...violations, v]; setViolations(u); DataService.violationTypes.save(u); };
            
            const addFacility = () => { if (!newFacility.name) return; const f = { ...newFacility, id: `f${Date.now()}`, name: newFacility.name }; const updated = [...facilities, f]; setFacilities(updated); DataService.facilities.save(updated); setNewFacility({ contractNumber: '', operatingCompany: '', location: '', phone: '', email: '' }); showToast('تم إضافة الموقع'); };
            const updateFacility = () => { if (!editingFacility) return; const updated = facilities.map(f => f.id === editingFacility.id ? editingFacility : f); setFacilities(updated); DataService.facilities.save(updated); setEditingFacility(null); showToast('تم تحديث الموقع'); };

            return (
                <div className="space-y-6 bg-white p-6 rounded shadow mt-6">
                    <h2 className="text-xl font-bold">الاعدادات</h2>
                    <div className="flex border-b mb-4 overflow-x-auto">{['FACILITIES','USERS','EMPLOYEES','ITEMS','VIOLATIONS','GENERAL'].map(t => (<button key={t} onClick={()=>setActiveTab(t)} className={`px-4 py-2 ${activeTab===t?'border-b-2 border-gold font-bold':''}`}>{t==='FACILITIES'?'المواقع':t==='USERS'?'المستخدمين':t==='EMPLOYEES'?'الموظفين':t==='ITEMS'?'البنود':t==='VIOLATIONS'?'المخالفات':'عام'}</button>))}</div>
                    {activeTab === 'GENERAL' && (<div className="grid md:grid-cols-2 gap-8"><div><h3 className="font-bold mb-2">الشعار</h3><div className="w-40 h-40 border-2 border-dashed flex items-center justify-center overflow-hidden mb-2">{logo?<img src={logo} className="w-full"/>:<span className="text-gray-400">لا يوجد</span>}</div><input type="file" onChange={e=>handleFile(e,'logo')}/></div></div>)}
                    {activeTab === 'FACILITIES' && (<div className="space-y-6"><div className="bg-gray-50 p-4 rounded"><h3 className="font-bold mb-4">{editingFacility ? 'تعديل موقع' : 'إضافة موقع جديد'}</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-4"><input placeholder="اسم المسلخ *" value={editingFacility ? editingFacility.name : newFacility.name || ''} onChange={e => editingFacility ? setEditingFacility({...editingFacility, name: e.target.value}) : setNewFacility({...newFacility, name: e.target.value})} className="border p-2"/><input placeholder="رقم العقد" value={editingFacility ? editingFacility.contractNumber : newFacility.contractNumber} onChange={e => editingFacility ? setEditingFacility({...editingFacility, contractNumber: e.target.value}) : setNewFacility({...newFacility, contractNumber: e.target.value})} className="border p-2"/><input placeholder="الشركة المشغلة" value={editingFacility ? editingFacility.operatingCompany : newFacility.operatingCompany} onChange={e => editingFacility ? setEditingFacility({...editingFacility, operatingCompany: e.target.value}) : setNewFacility({...newFacility, operatingCompany: e.target.value})} className="border p-2"/><input placeholder="الموقع الجغرافي" value={editingFacility ? editingFacility.location : newFacility.location} onChange={e => editingFacility ? setEditingFacility({...editingFacility, location: e.target.value}) : setNewFacility({...newFacility, location: e.target.value})} className="border p-2"/><input placeholder="الهاتف" value={editingFacility ? editingFacility.phone : newFacility.phone} onChange={e => editingFacility ? setEditingFacility({...editingFacility, phone: e.target.value}) : setNewFacility({...newFacility, phone: e.target.value})} className="border p-2"/><input placeholder="البريد الإلكتروني" value={editingFacility ? editingFacility.email : newFacility.email} onChange={e => editingFacility ? setEditingFacility({...editingFacility, email: e.target.value}) : setNewFacility({...newFacility, email: e.target.value})} className="border p-2"/></div><div className="mt-4">{editingFacility ? (<div className="flex gap-2"><button onClick={updateFacility} className="bg-green-600 text-white px-4 py-2 rounded">حفظ التعديلات</button><button onClick={() => setEditingFacility(null)} className="bg-gray-600 text-white px-4 py-2 rounded">إلغاء</button></div>) : (<button onClick={addFacility} className="bg-blue-600 text-white px-4 py-2 rounded">إضافة موقع</button>)}</div></div><div className="mt-6"><h3 className="font-bold mb-4">قائمة المواقع</h3><div className="space-y-4">{facilities.map(facility => (<div key={facility.id} className="border rounded p-4 hover:bg-gray-50"><div className="flex justify-between items-start"><div className="flex-1"><h4 className="font-bold text-lg">{facility.name}</h4><div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2 text-sm"><div><span className="font-semibold">رقم العقد:</span><p>{facility.contractNumber || 'غير محدد'}</p></div><div><span className="font-semibold">الشركة المشغلة:</span><p>{facility.operatingCompany || 'غير محدد'}</p></div><div><span className="font-semibold">الموقع:</span><p>{facility.location || 'غير محدد'}</p></div><div><span className="font-semibold">الاتصال:</span><p>{facility.phone || 'غير محدد'}</p><p>{facility.email || 'غير محدد'}</p></div></div></div><div className="flex gap-2"><button onClick={() => setEditingFacility(facility)} className="text-blue-600 hover:text-blue-800"><i className="fa fa-edit"></i></button><button onClick={() => { const updated = facilities.filter(f => f.id !== facility.id); setFacilities(updated); DataService.facilities.save(updated); showToast('تم حذف الموقع'); }} className="text-red-600 hover:text-red-800"><i className="fa fa-trash"></i></button></div></div></div>))}</div></div></div>)}
                    {activeTab === 'USERS' && (<div><div className="grid grid-cols-4 gap-4 bg-gray-50 p-4 mb-4"><input placeholder="الرقم" onChange={e => setNewUser({...newUser, id: e.target.value})} className="border p-2"/><input placeholder="الاسم" onChange={e => setNewUser({...newUser, name: e.target.value})} className="border p-2"/><select onChange={e => setNewUser({...newUser, role: e.target.value})} className="border p-2">{Object.values(UserRole).map(r=><option key={r} value={r}>{r}</option>)}</select><select onChange={e => setNewUser({...newUser, facilityId: e.target.value})} className="border p-2"><option value="">الموقع</option>{facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}</select><button onClick={addUser} className="bg-green-600 text-white col-span-4">حفظ / تحديث</button></div><ul>{users.map(u => <li key={u.id} className="border-b p-2 flex justify-between"><span>{u.name} ({u.role}) - {facilities.find(f=>f.id===u.facilityId)?.name}</span><button className="text-red-500" onClick={()=>{const n=users.filter(x=>x.id!==u.id); setUsers(n); DataService.users.save(n);}}>حذف</button></li>)}</ul></div>)}
                    {activeTab === 'EMPLOYEES' && (<div><div className="grid grid-cols-4 gap-4 bg-gray-50 p-4 mb-4"><input placeholder="الاسم" onChange={e => setNewEmp({...newEmp, name: e.target.value})} className="border p-2"/><input placeholder="الوظيفة" onChange={e => setNewEmp({...newEmp, jobTitle: e.target.value})} className="border p-2"/><input type="number" placeholder="الراتب" onChange={e => setNewEmp({...newEmp, salary: Number(e.target.value)})} className="border p-2"/><select onChange={e => setNewEmp({...newEmp, facilityId: e.target.value})} className="border p-2"><option value="">الموقع</option>{facilities.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}</select><button onClick={addEmp} className="bg-green-600 text-white col-span-4">إضافة</button></div><ul>{employees.map(e => <li key={e.id} className="border-b p-2 flex justify-between"><span>{e.name} - {facilities.find(f=>f.id===e.facilityId)?.name}</span><button className="text-red-500" onClick={()=>{const n=employees.filter(x=>x.id!==e.id); setEmployees(n); DataService.employees.save(n);}}>حذف</button></li>)}</ul></div>)}
                    {activeTab === 'ITEMS' && (<div><div className="grid grid-cols-3 gap-4 bg-gray-50 p-4 mb-4"><input placeholder="البند" onChange={e => setNewItem({...newItem, name: e.target.value})} className="border p-2"/><select onChange={e => setNewItem({...newItem, category: e.target.value})} className="border p-2"><option value="ADMIN">إدارية</option><option value="OPERATIONAL">تشغيلية</option><option value="PROFESSIONAL">مهنية</option><option value="HYGIENE">نظافة</option><option value="SAFETY">سلامة</option><option value="LAB">مختبر</option></select><button onClick={addItem} className="bg-green-600 text-white">إضافة</button></div><ul>{items.map(i => <li key={i.id} className="border-b p-2 flex justify-between"><span>{i.name} ({i.category})</span><button className="text-red-500" onClick={()=>{const n=items.filter(x=>x.id!==i.id); setItems(n); DataService.items.save(n);}}>حذف</button></li>)}</ul></div>)}
                    {activeTab === 'VIOLATIONS' && (<div><div className="grid grid-cols-3 gap-4 bg-gray-50 p-4 mb-4"><input placeholder="المخالفة" onChange={e => setNewViolation({...newViolation, name: e.target.value})} className="border p-2"/><input type="number" placeholder="الغرامة" onChange={e => setNewViolation({...newViolation, fineAmount: Number(e.target.value)})} className="border p-2"/><button onClick={addViol} className="bg-green-600 text-white">إضافة</button></div><ul>{violations.map(v => <li key={v.id} className="border-b p-2 flex justify-between"><span>{v.name} ({v.fineAmount})</span><button className="text-red-500" onClick={()=>{const n=violations.filter(x=>x.id!==v.id); setViolations(n); DataService.violationTypes.save(n);}}>حذف</button></li>)}</ul></div>)}
                </div>
            );
        };

        // --- APP ROOT ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);

            useEffect(() => { const s = localStorage.getItem('currentUser'); if (s) setCurrentUser(JSON.parse(s)); }, []);
            const handleLogin = (u) => { setCurrentUser(u); localStorage.setItem('currentUser', JSON.stringify(u)); };
            const handleLogout = () => { setCurrentUser(null); localStorage.removeItem('currentUser'); };

            if (!currentUser) return <Login onLogin={handleLogin} />;

            return (
                <ToastProvider>
                    <HashRouter>
                        <Layout currentUser={currentUser} onLogout={handleLogout}>
                            <Routes>
                                <Route path="/" element={<Navigate to="/daily-evaluation" replace />} />
                                <Route path="/daily-evaluation" element={<DailyEvaluationPage currentUser={currentUser} />} />
                                <Route path="/violations" element={<ViolationsPage currentUser={currentUser} />} />
                                <Route path="/monthly-evaluation" element={<MonthlyEvaluationPage currentUser={currentUser} />} />
                                <Route path="/monthly-report" element={<MonthlyReportPage currentUser={currentUser} />} />
                                <Route path="/kpi" element={<KPIPage currentUser={currentUser} />} />
                                <Route path="/invoice" element={<MonthlyInvoicePage currentUser={currentUser} />} />
                                <Route path="/extra-labor" element={<ExtraLaborPage currentUser={currentUser} />} />
                                <Route path="/settings" element={<SettingsPage />} />
                            </Routes>
                        </Layout>
                    </HashRouter>
                </ToastProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
